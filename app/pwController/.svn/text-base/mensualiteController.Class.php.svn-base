<?php

class mensualiteController extends MwController {
	
	public function actionBeforDisplay(){
		$smarty = MwSmarty::getInstance();
	
		$formationList = MwFormations::getSelectFormationList();
		$smarty->assign( 'formationList',$formationList );
		
		$etudientList = MwEtudiants::getSelectEtudiantList();
		$smarty->assign( 'etudientList',$etudientList );
		
	}
	
	public function actionGetList(){
		$frmid = $_POST['frmid'];

		$lst = MwMensualites::getListByFormation($frmid);
		
		$text = json_encode($lst);
		$search  = array('\\r', '\\n','null',"'");
		$replace = array('', "\\\\n", '""',"\\\\'");
		$text = str_replace($search, $replace, $text);
		echo $text;
	}
	
	public function actionSave(){
		$new = 0;
		$MEN_ID = $_POST['MEN_ID'];
		$MEN_FRM_ID = $_POST['MEN_FRM_ID'];
		$MEN_ETU_ID = $_POST['MEN_ETU_ID'];
		$MEN_PRIX_FRM = $_POST['MEN_PRIX_FRM'];
		$MEN_MENSUALITE = $_POST['MEN_MENSUALITE'];

		$REC_DATE_BEGIN = $_POST['REC_DATE_BEGIN'];
		$REC_NBR = $_POST['REC_NBR'];
		$REC_JMOIS = $_POST['REC_JMOIS'];
		
		
		if ($MEN_ID == ''){
			if(MwMensualites::coupleExiste($MEN_FRM_ID, $MEN_ETU_ID) > 0 ){
				echo "enregistrement déjà existant !";
				return 0;
			} 
			$new= 1;
		}
		
		$obj = new MwMensualites($MEN_ID);
		$obj->MEN_FRM_ID = $MEN_FRM_ID;
		$obj->MEN_ETU_ID = $MEN_ETU_ID;
		$obj->MEN_PRIX_FRM = $MEN_PRIX_FRM;
		$obj->MEN_MENSUALITE = $MEN_MENSUALITE;
		

		$date = new DateTime($REC_DATE_BEGIN);
		
		$id = $obj->save();
		if ($new == 1){
			for($i=0; $i <  $obj->MEN_MENSUALITE ; $i++){
				
				
				$obj1 = new MwPaiements();
				$obj1->PYE_MEN_ID = $id;
				$obj1->PYE_FRM_ID= $obj->MEN_FRM_ID;
				$obj1->PYE_ETU_ID= $obj->MEN_ETU_ID;
				$obj1->PYE_DATE= $date->format('Y-m-d');
				$obj1->PYE_PREVISION= ($obj->MEN_PRIX_FRM / ($obj->MEN_MENSUALITE==0?1:$obj->MEN_MENSUALITE));
				$obj1->PYE_PAIEMENT= 0;
				$obj1->save();
				
				$tadd = "";
				if($REC_JMOIS=='mois'){
					$tadd = "+".$REC_NBR." month";
				}
				elseif($REC_JMOIS=='jours'){
					$tadd = "+".$REC_NBR." day";
				}
				$date->modify($tadd);
				
			}
		}
		
		echo "Enregistrement terminé";
	}
	
	/**
	 * actionDelete
	 */
	public function actionDelete(){
		$MEN_ID = $_POST['MEN_ID'];
	
		if(strlen($MEN_ID)<>16){
			$MEN_ID = '';
			return;
		}
		$obj = new MwMensualites($MEN_ID);
		$obj->delete();
		MwPaiements::deletePaiementByMens($MEN_ID);
	}
	
	
	/**
	 * actionGetDetails
	 */
	public function actionGetDetails(){
		$mend_id = $_POST['mend_id'];
	
		$lst = MwPaiements::getListDetails($mend_id);
	
		$text = json_encode($lst);
		$search  = array('\\r', '\\n','null',"'");
		$replace = array('', "\\\\n", '""',"\\\\'");
		$text = str_replace($search, $replace, $text);
		echo $text;
	}
	
	
	/**
	 * actionDeletePaiement
	 */
	public function actionDeletePaiement(){
		$pyeId = $_POST['pyeId'];
		$obj = new MwPaiements($pyeId);
		$obj->delete();
		echo "Paiement Supprimé !";
	}
	
	/**
	 * actionEditePaiement
	 */
	public function actionEditPaiement(){
		$PYE_ID = $_POST['PYE_ID'];
		$PYE_MEN_ID = $_POST['PYE_MEN_ID'];
		$PYE_FRM_ID = $_POST['PYE_FRM_ID'];
		$PYE_ETU_ID = $_POST['PYE_ETU_ID'];
		$PYE_DATE = $_POST['PYE_DATE'];
		$PYE_PREVISION = $_POST['PYE_PREVISION'];
		$PYE_PAIEMENT = $_POST['PYE_PAIEMENT'];
		
		$PYE_MODE = $_POST['PYE_MODE'];
		
		$PYE_DATE_PAYEMENT = $_POST['PYE_DATE_PAYEMENT'];
				
		$PYE_REMIS = (isset($_POST['PYE_REMIS'])?1:0);

		
		$obj = new MwPaiements($PYE_ID);
		$obj->PYE_MEN_ID = $PYE_MEN_ID;
		$obj->PYE_FRM_ID = $PYE_FRM_ID;
		$obj->PYE_ETU_ID = $PYE_ETU_ID;
		$obj->PYE_DATE   = $PYE_DATE;
		$obj->PYE_PREVISION = $PYE_PREVISION;
		$obj->PYE_PAIEMENT = $PYE_PAIEMENT;
		$obj->PYE_REMIS = $PYE_REMIS;
		$obj->PYE_DATE_PAYEMENT= $PYE_DATE_PAYEMENT;
		$obj->PYE_MODE = $PYE_MODE;
		$obj->save();
		echo("Paiement enregistré !");
		
	}
	
	/**
	 * actionGetEtudOfForm
	 */
	public function actionGetEtudOfForm(){
		$FORM_ID = $_POST['FORM_ID'];
		$lst = MwEtudiants::getListEtudByFormation($FORM_ID);
		
		
		$text = json_encode($lst);
		$search  = array('\\r', '\\n','null',"'");
		$replace = array('', "\\\\n", '""',"\\\\'");
		$text = str_replace($search, $replace, $text);
		//$text = substr($text, 1, strlen($text)-2);
		echo $text;
	
	}
}






